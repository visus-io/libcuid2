name: Continuous Integration

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'man/**'
      - 'debian/**'
      - 'renovate.json'
      - 'LICENSE'
      - '.gitignore'
      - '.github/workflows/lint_pullrequest.yml'
  pull_request:
    paths-ignore:
      - '**.md'
      - 'man/**'
      - 'debian/**'
      - 'renovate.json'
      - 'LICENSE'
      - '.gitignore'
      - '.github/workflows/lint_pullrequest.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    permissions:
      contents: read
      actions: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Setup build tools
        uses: lukka/get-cmake@9e07ecdcee1b12e5037e42f410b67f03e2f626e1 # v4.2.1
        with:
          cmakeVersion: '~3.28.0'
          ninjaVersion: '^1.12.0'

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libssl-dev \
            libboost-all-dev \
            libfmt-dev \
            python3-pip
          pip3 install gcovr==8.4

      - name: Setup vcpkg binary cache (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $cachePath = "$env:USERPROFILE\AppData\Local\vcpkg\archives"
          echo "VCPKG_BINARY_SOURCES=files,$cachePath,readwrite" >> $env:GITHUB_ENV

      - name: Setup vcpkg binary cache (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "VCPKG_BINARY_SOURCES=files,$HOME/.cache/vcpkg/archives,readwrite" >> $GITHUB_ENV

      - name: Cache vcpkg (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ~/AppData/Local/vcpkg/archives
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Cache vcpkg (Linux)
        if: runner.os == 'Linux'
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ~/.cache/vcpkg/archives
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json', 'vcpkg-configuration.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@5e0cab206a5ea620130caf672fce3e4a6b5666a1 # v11.5

      - name: Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@0b201ec74fa43914dc39ae48a89fd1d8cb592756 # v1.13.0

      - name: Configure (Linux)
        if: runner.os == 'Linux'
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DBUILD_TESTS=ON \
            -DENABLE_COVERAGE=ON \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_OVERLAY_PORTS=${{ github.workspace }}/cmake/vcpkg/ports \
            -DVCPKG_OVERLAY_TRIPLETS=${{ github.workspace }}/cmake/vcpkg/triplets

      - name: Configure (Windows)
        if: runner.os == 'Windows'
        run: |
          cmake -B build `
            -G Ninja `
            -DCMAKE_BUILD_TYPE=Debug `
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON `
            -DBUILD_TESTS=ON `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"

      - name: Build
        run: cmake --build build

      - name: Verify Linux linkage
        if: runner.os == 'Linux'
        run: |
          echo "Checking library dependencies..."
          ldd build/libcuid2.so | grep -E "(openssl|boost|fmt)" || echo "No system libraries found in ldd output"
          echo ""
          echo "Verifying system libraries are used (not vcpkg)..."
          if ldd build/libcuid2.so | grep -q "vcpkg_installed"; then
            echo "ERROR: vcpkg libraries detected instead of system libraries!"
            exit 1
          else
            echo "SUCCESS: Using system libraries"
          fi

      - name: Test
        run: ctest --test-dir build --output-on-failure

      - name: Coverage
        if: runner.os == 'Linux'
        run: |
          cd build
          gcovr . \
            --root .. \
            --sonarqube coverage.xml \
            --filter '../src/' \
            --exclude '../src/cuid2gen.cpp' \
            --print-summary

          # Remove branch coverage attributes from SonarQube XML
          # This excludes compiler-generated STL branches that cannot be meaningfully tested
          sed -i.bak 's/ branchesToCover="[0-9]*"//g; s/ coveredBranches="[0-9]*"//g' coverage.xml

      - name: Upload SonarQube artifacts
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: sonarqube-artifacts
          path: |
            build/coverage.xml
            build/compile_commands.json
          retention-days: 1

  sonar-analyze:
    name: SonarQube Analysis
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]' && github.actor != 'renovate[bot]'
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Download SonarQube artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: sonarqube-artifacts
          path: build/

      - name: Analyze
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
